{% extends 'admin/layout.html' %}

{% block title %}Manage Gallery - World Hotels{% endblock %}

{% block page_title %}
<div class="d-flex flex-column flex-sm-row justify-content-between align-items-center align-items-sm-center gap-3 w-100">
    <h1 class="h3 mb-0">Manage Gallery</h1>
    <button type="button" class="btn btn-dark float-end" data-bs-toggle="modal" data-bs-target="#addImageModal">
        <i class="bi bi-plus-lg"></i> Add New Image
    </button>
</div>
{% endblock %}

{% block content %}
<div id="alertMessage" class="alert" style="display: none;" role="alert"></div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="col-md-3">
                <label class="form-label">Hotel</label>
                <select name="hotel_id" class="form-select">
                    <option value="">All Hotels</option>
                    {% for hotel in hotels %}
                    <option value="{{ hotel.hotel_id }}" 
                            {% if current_hotel|string == hotel.hotel_id|string %}selected{% endif %}>
                        {{ hotel.hotel_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Category</label>
                <select name="category" class="form-select">
                    <option value="">All Categories</option>
                    <option value="rooms" {% if current_category == 'rooms' %}selected{% endif %}>Rooms</option>
                    <option value="dining" {% if current_category == 'dining' %}selected{% endif %}>Dining</option>
                    <option value="amenities" {% if current_category == 'amenities' %}selected{% endif %}>Amenities</option>
                    <option value="spa" {% if current_category == 'spa' %}selected{% endif %}>Spa</option>
                    <option value="events" {% if current_category == 'events' %}selected{% endif %}>Events</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                    <option value="">All Statuses</option>
                    <option value="active" {% if current_status == 'active' %}selected{% endif %}>Active</option>
                    <option value="inactive" {% if current_status == 'inactive' %}selected{% endif %}>Inactive</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button type="submit" class="btn btn-dark">
                        <i class="bi bi-filter"></i> Filter
                    </button>
                    <a href="{{ url_for('manage_gallery') }}" class="btn btn-outline-dark">
                        <i class="bi bi-x-lg"></i> Clear
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if gallery_images %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Title</th>
                        <th>Hotel</th>
                        <th>Category</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for image in gallery_images %}
                    <tr>
                        <td>
                            <img src="{{ image.image_url }}" alt="{{ image.title }}" 
                                 style="width: 100px; height: 60px; object-fit: cover; border-radius: 4px;">
                        </td>
                        <td>{{ image.title }}</td>
                        <td>{{ image.hotel_name or 'No Hotel' }}</td>
                        <td>{{ image.category }}</td>
                        <td>
                            <span class="badge bg-{{ 'success' if image.is_active else 'danger' }}">
                                {{ 'Active' if image.is_active else 'Inactive' }}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="editImage({{ image.gallery_id }})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteImage({{ image.gallery_id }})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-4">
            <div class="text-muted">
                Showing {{ gallery_images|length }} of {{ total_images }} images
            </div>
            
            {% if total_pages > 1 %}
            <nav aria-label="Gallery navigation">
                <ul class="pagination">
                    {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('manage_gallery', page=page-1, hotel_id=current_hotel, category=current_category, status=current_status) }}">
                            <i class="bi bi-arrow-left"></i> Previous
                        </a>
                    </li>
                    {% endif %}
                    
                    {# First page #}
                    {% if page > 3 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('manage_gallery', page=1, hotel_id=current_hotel, category=current_category, status=current_status) }}">1</a>
                    </li>
                    {% if page > 4 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                    {% endif %}
                    
                    {# Pages around current page #}
                    {% for p in range(page - 2, page + 3) %}
                        {% if p > 0 and p <= total_pages %}
                        <li class="page-item {{ 'active' if p == page }}">
                            <a class="page-link" href="{{ url_for('manage_gallery', page=p, hotel_id=current_hotel, category=current_category, status=current_status) }}">{{ p }}</a>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {# Last page #}
                    {% if page < total_pages - 2 %}
                    {% if page < total_pages - 3 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('manage_gallery', page=total_pages, hotel_id=current_hotel, category=current_category, status=current_status) }}">{{ total_pages }}</a>
                    </li>
                    {% endif %}
                    
                    {% if page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('manage_gallery', page=page+1, hotel_id=current_hotel, category=current_category, status=current_status) }}">
                            Next <i class="bi bi-arrow-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-calendar-x" style="font-size: 3rem; color: #ccc;"></i>
            <h5 class="mt-3">No Gallery Images Found</h5>
            <p class="text-muted">Try adjusting your filters or clearing them to see more results.</p>
            <a href="{{ url_for('manage_gallery') }}" class="btn btn-outline-dark mt-2">
                Clear All Filters
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Image Modal -->
<div class="modal fade" id="addImageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Gallery Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" enctype="multipart/form-data" action="{{ url_for('add_gallery_image') }}">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" name="title" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Image</label>
                        <input type="file" name="image" class="form-control" accept="image/*" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Hotel</label>
                        <select name="hotel_id" class="form-select" required>
                            <option value="">Select Hotel</option>
                            {% for hotel in hotels %}
                            <option value="{{ hotel.hotel_id }}">{{ hotel.hotel_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select name="category" class="form-select" required>
                            <option value="rooms">Rooms</option>
                            <option value="dining">Dining</option>
                            <option value="amenities">Amenities</option>
                            <option value="spa">Spa</option>
                            <option value="events">Events</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-dark">Add Image</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Edit Image Modal -->
<div class="modal fade" id="editImageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Gallery Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" enctype="multipart/form-data" id="editImageForm">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" name="title" id="editTitle" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Hotel</label>
                        <select name="hotel_id" id="editHotelId" class="form-select" required>
                            <option value="">Select Hotel</option>
                            {% for hotel in hotels %}
                            <option value="{{ hotel.hotel_id }}">{{ hotel.hotel_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Current Image</label>
                        <img id="currentImage" src="" alt="Current Image" 
                             style="max-width: 100%; height: 200px; object-fit: cover; border-radius: 4px;">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">New Image (optional)</label>
                        <input type="file" name="image" class="form-control" accept="image/*">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select name="category" id="editCategory" class="form-select" required>
                            <option value="rooms">Rooms</option>
                            <option value="dining">Dining</option>
                            <option value="amenities">Amenities</option>
                            <option value="spa">Spa</option>
                            <option value="events">Events</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" id="editDescription" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function editImage(id) {
    fetch(`/admin/gallery/${id}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const image = data.image;
                
                // Update form fields
                document.getElementById('editImageForm').action = `/admin/gallery/${id}/edit`;
                document.getElementById('editTitle').value = image.title;
                document.getElementById('editCategory').value = image.category;
                document.getElementById('editDescription').value = image.description || '';
                document.getElementById('editHotelId').value = image.hotel_id || '';
                document.getElementById('currentImage').src = image.image_url;
                
                new bootstrap.Modal(document.getElementById('editImageModal')).show();
            } else {
                alert('Error loading image details');
            }
        });
}

function showAlert(message, type = 'success') {
    const alertDiv = document.getElementById('alertMessage');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    alertDiv.style.display = 'block';
    
    // Hide after 3 seconds
    setTimeout(() => {
        alertDiv.style.display = 'none';
    }, 3000);
}

function deleteImage(id) {
    if (confirm('Are you sure you want to delete this image?')) {
        // Disable the delete button
        const button = event.target.closest('button');
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Deleting...';
        
        fetch(`/admin/gallery/${id}/delete`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Image deleted successfully');
                // Remove the table row
                const row = button.closest('tr');
                row.remove();
            } else {
                showAlert(data.message || 'Error deleting image', 'danger');
                // Reset the button
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-trash"></i>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error deleting image', 'danger');
            // Reset the button
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-trash"></i>';
        });
    }
}
</script>
{% endblock %}