<!-- templates/booking/hotel_list.html -->

{% extends 'common/base.html' %}

{% block title %}Available Hotels - World Hotels{% endblock %}

{% block extra_css %}

<style>
    /* Search Summary Styling */
    .search-summary {
        background: #F8F9FA;
        padding: 1.5rem 0;
        border-bottom: 1px solid #dee2e6;
    }

    .search-summary h5 {
        color: #495057;
        font-weight: 400;
        font-family: 'Playfair Display', serif;
    }

    /* Filters Sidebar */
    .filters-sidebar {
        background: white;
        padding: 1.5rem;
        border: 1px solid #dee2e6;
    }

    .filters-sidebar h5 {
        font-family: 'Playfair Display', serif;
        color: #333;
        margin-bottom: 1.5rem;
    }

    .filters-sidebar h6 {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #495057;
        margin-bottom: 1rem;
    }

    .form-check {
        margin-bottom: 0.5rem;
    }

    .form-check-label {
        color: #666;
        font-size: 0.95rem;
    }

    /* Hotel Cards */
    .hotel-card {
        margin-bottom: 1.5rem;
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
    }

    .hotel-image {
        height: 100%;
        object-fit: cover;
    }

    .discount-badge {
        position: absolute;
        top: 1rem;
        left: 1rem;
        background: #9D8E7C;
        color: white;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .card-title {
        font-family: 'Playfair Display', serif;
        font-size: 1.5rem;
        color: #333;
    }

    .price-display {
        font-size: 1.25rem;
        color: #9D8E7C;
        font-weight: 500;
    }

    .hotel-description {
        color: #666;
        font-size: 0.95rem;
        line-height: 1.6;
        margin-bottom: 1rem;
    }

    /* Room Types and Amenities */
    .room-type-badge, .amenity-badge {
        display: inline-block;
        background: #f8f9fa;
        padding: 0.4rem 0.8rem;
        margin: 0.25rem;
        border-radius: 20px;
        font-size: 0.85rem;
        color: #495057;
    }

    .amenity-badge i {
        color: #9D8E7C;
    }


    .sort-dropdown {
        width: auto;
        min-width: 200px;
        border-radius: 0;
        border-color: #dee2e6;
        font-size: 0.9rem;
    }


    .btn-outline-dark {
        border-radius: 0;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.85rem;
        padding: 0.5rem 1.5rem;
        transition: all 0.3s ease;
    }

    .btn-dark {
        border-radius: 0;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.85rem;
        padding: 0.5rem 1.5rem;
        background: #000;
        transition: all 0.3s ease;
    }

    .btn-dark:hover {
        background: #9D8E7C;
        border-color: #9D8E7C;
    }

    @media (max-width: 991px) {
        .search-summary {
            padding: 1rem 0;
        }

        .search-summary .row {
            flex-direction: column;
            gap: 1rem;
        }

        .search-summary h5 {
            font-size: 1rem;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .search-summary .text-end {
            text-align: center !important;
        }

        .search-summary .btn-outline-dark {
            width: 200px;
            margin: 0 auto;
        }
        .col-md-3 {
            margin-bottom: 2rem;
        }
        
        .col-md-9 {
            width: 100%;
        }
        
        .hotel-card .row {
            flex-direction: column;
        }
        
        .hotel-card .col-md-4 {
            width: 100%;
        }
        
        .hotel-card .col-md-8 {
            width: 100%;
        }
        
        .hotel-image {
            height: 300px;
            width: 100%;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .sort-dropdown {
            width: 200px;
        }
        
        .btn-dark {
            width: auto;
        }
    }

    @media (min-width: 768px) and (max-width: 991px) {
        .col-md-3 {
            width: 35%;
            float: left;
        }
        
        .col-md-9 {
            width: 65%;
            float: left;
        }
        
        .filters-sidebar {
            margin-right: 1rem;
        }
    }

    @media (max-width: 425px) {
        .search-summary h5 {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .search-summary h5 span {
            display: inline-block;
        }

        .hotel-image {
            height: 200px;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .card-title {
            font-size: 1.25rem;
        }
        
        .price-display {
            font-size: 1.1rem;
        }
        
        .hotel-description {
            font-size: 0.9rem;
        }
        
        .room-type-badge, 
        .amenity-badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }
        
        .sort-dropdown {
            width: 100%;
            margin-top: 1rem;
        }
        
        .btn-dark {
            width: 100%;
            margin-top: 1rem;
        }
        
        .hotels-found {
            font-size: 1.1rem;
        }
        
        .d-flex.justify-content-between.align-items-center {
            flex-direction: column;
            align-items: stretch !important;
        }
        
        .d-flex.justify-content-between.align-items-center > div {
            margin-bottom: 1rem;
            text-align: center;
        }
    }

    /* Custom Checkbox Styling */
    .form-check-input {
        border-radius: 0;
        border-color: #dee2e6;
    }

    .form-check-input:checked {
        background-color: #9D8E7C;
        border-color: #9D8E7C;
    }

    /* No Results Message */
    .no-results-message {
        padding: 3rem 1rem;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
    }

    .no-results-message h4 {
        font-family: 'Playfair Display', serif;
        color: #333;
        margin-bottom: 1rem;
    }
</style>

{% endblock %}

{% block content %}
<!-- Search Summary -->
<div class="search-summary">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h5 class="mb-0">
                    {{ city }} | {{ check_in|date }} - {{ check_out|date }} | 
                    {{ total_nights }} night{% if total_nights != 1 %}s{% endif %} | 
                    {{ total_guests }} guest{% if total_guests != 1 %}s{% endif %}
                </h5>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-outline-dark" onclick="history.back()">
                    Modify Search
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container py-4">
    <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-md-3">
            <div class="filters-sidebar">
                <h5>Filters</h5>
                <form id="filterForm">
                    <!-- Room Types -->
                    <div class="mb-4">
                        <h6>Room Types</h6>
                        {% for type in room_types %}
                        <div class="form-check">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   value="{{ type.room_type_id }}"
                                   id="room_type_{{ type.room_type_id }}"
                                   {% if type.room_type_id|string in selected_room_types %}checked{% endif %}>
                            <label class="form-check-label" for="room_type_{{ type.room_type_id }}">
                                {{ type.type_name }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Amenities -->
                    <div class="mb-4">
                        <h6>Amenities</h6>
                        {% for amenity in amenities %}
                        <div class="form-check amenity-checkbox">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   value="{{ amenity.amenity_id }}"
                                   id="amenity_{{ amenity.amenity_id }}">
                            <label class="form-check-label" for="amenity_{{ amenity.amenity_id }}">
                                {% if amenity.icon_class %}
                                <i class="{{ amenity.icon_class }} me-2"></i>
                                {% endif %}
                                {{ amenity.name }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </form>
            </div>
        </div>

        <!-- Hotel Listings -->
        <div class="col-md-9">
            <!-- Sort Options -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h5 class="mb-0 hotels-found">{{ hotels|length }} hotels found</h5>
                </div>
                <select class="form-select sort-dropdown" onchange="sortHotels(this.value)">
                    <option value="price_asc" {% if sort_by == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
                    <option value="price_desc" {% if sort_by == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
                    <option value="name_asc" {% if sort_by == 'name_asc' %}selected{% endif %}>Name: A to Z</option>
                </select>
            </div>

            <!-- Hotel Cards -->
            <div class="hotel-listings">
                {% for hotel in hotels %}
                <div class="card hotel-card" 
                    data-price="{{ hotel.price }}"
                    data-name="{{ hotel.hotel_name }}"
                    data-room-types='{{ hotel.available_rooms|map(attribute="room_type_id")|list|tojson|safe }}'
                    data-amenities='{{ hotel.amenities|tojson|safe }}'>
                    <div class="row g-0">
                        <div class="col-md-4 position-relative">
                            <img src="{{ hotel.hotel_image }}" 
                                 class="hotel-image img-fluid" 
                                 alt="{{ hotel.hotel_name }}">
                            {% if hotel.discount_percentage > 0 %}
                            <div class="discount-badge">
                                {{ hotel.discount_percentage }}% OFF
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-8">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h5 class="card-title mb-1">{{ hotel.hotel_name }}</h5>
                                    <div class="text-end">
                                        <div class="price-display">
                                            {{ hotel.price|currency(selected_currency) }}
                                        </div>
                                        <small class="text-muted">per night</small>
                                    </div>
                                </div>
                                
                                <p class="card-text text-muted mb-2">
                                    <i class="fas fa-map-marker-alt"></i> {{ hotel.address }}
                                </p>

                                <p class="hotel-description">
                                    {{ hotel.description }}
                                </p>

                                <!-- Available Room Types -->
                                <div class="mb-3">
                                    <h6 class="mb-2">Available Rooms:</h6>
                                    {% for room in hotel.available_rooms %}
                                    <span class="room-type-badge">
                                        {{ room.type_name }} ({{ room.available }} available)
                                    </span>
                                    {% endfor %}
                                </div>

                                <!-- Amenities -->
                                <div class="mb-3">
                                    <h6 class="mb-2">Amenities:</h6>
                                    <div class="d-flex flex-wrap">
                                        {% for amenity in hotel.amenities[:5] %}
                                        <span class="amenity-badge">
                                            <i class="{{ amenity.icon_class }} me-1"></i>
                                            {{ amenity.name }}
                                        </span>
                                        {% endfor %}
                                        {% if hotel.amenities|length > 5 %}
                                        <span class="amenity-badge">
                                            +{{ hotel.amenities|length - 5 }} more
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">
                                            {{ total_nights }} night{% if total_nights != 1 %}s{% endif %} total:
                                            <strong>{{ hotel.total_price|currency(selected_currency) }}</strong>
                                        </small>
                                    </div>
                                    <a href="{{ url_for('room_list', 
                                            hotel_id=hotel.hotel_id,
                                            check_in=check_in.strftime('%Y-%m-%d'),
                                            check_out=check_out.strftime('%Y-%m-%d'),
                                            guests=total_guests,
                                            rooms=rooms,
                                            currency=selected_currency) }}" 
                                        class="btn btn-dark">
                                        View Rooms
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <h4>No hotels found matching your criteria</h4>
                    <p class="text-muted">Try modifying your search parameters</p>
                    <button class="btn btn-outline-dark" onclick="history.back()">
                        Modify Search
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Room types and amenities filters
    document.querySelectorAll('.form-check-input').forEach(checkbox => {
        checkbox.addEventListener('change', filterHotels);
    });

    function filterHotels() {
        const selectedRoomTypes = Array.from(document.querySelectorAll('input[id^="room_type_"]:checked'))
            .map(cb => parseInt(cb.value))
            .filter(id => !isNaN(id));
        const selectedAmenities = Array.from(document.querySelectorAll('input[id^="amenity_"]:checked'))
            .map(cb => parseInt(cb.value))
            .filter(id => !isNaN(id));

        document.querySelectorAll('.hotel-card').forEach(card => {
            const roomTypes = JSON.parse(card.dataset.roomTypes);
            const amenities = JSON.parse(card.dataset.amenities);

            // Room type matching
            const roomTypeMatch = selectedRoomTypes.length === 0 || 
                selectedRoomTypes.some(rt => roomTypes.includes(rt));

            // Amenity matching
            const amenityMatch = selectedAmenities.length === 0 || 
                selectedAmenities.every(selectedAmenity => 
                    amenities.some(hotelAmenity => hotelAmenity.amenity_id === selectedAmenity)
                );

            const shouldShow = roomTypeMatch && amenityMatch;
            card.style.display = shouldShow ? 'flex' : 'none';
        });

        updateHotelCount();
    }

    function updateHotelCount() {
        const visibleCount = document.querySelectorAll('.hotel-card[style*="display: flex"]').length;
        const hotelsFoundText = document.querySelector('.hotels-found');
        hotelsFoundText.textContent = `${visibleCount} hotels found`;

        const hotelListings = document.querySelector('.hotel-listings');
        let noResultsDiv = hotelListings.querySelector('.no-results-message');
        
        if (visibleCount === 0) {
            if (!noResultsDiv) {
                noResultsDiv = document.createElement('div');
                noResultsDiv.className = 'no-results-message text-center py-5';
                noResultsDiv.innerHTML = `
                    <h4>No hotels found matching your criteria</h4>
                    <p class="text-muted">Try modifying your filter selections</p>
                `;
                hotelListings.appendChild(noResultsDiv);
            }
            noResultsDiv.style.display = 'block';
        } else if (noResultsDiv) {
            noResultsDiv.style.display = 'none';
        }
    }
});

function sortHotels(sortBy) {
    const hotelCards = Array.from(document.querySelectorAll('.hotel-card'));
    const container = document.querySelector('.hotel-listings');
    
    hotelCards.sort((a, b) => {
        if (sortBy === 'name_asc') {
            return a.dataset.name.localeCompare(b.dataset.name);
        }
        
        const aValue = parseFloat(a.dataset[sortBy.split('_')[0]]);
        const bValue = parseFloat(b.dataset[sortBy.split('_')[0]]);
        return sortBy.endsWith('asc') ? aValue - bValue : bValue - aValue;
    });

    container.innerHTML = '';
    hotelCards.forEach(card => container.appendChild(card));
}

function formatCurrency(amount) {
    const currency = '{{ selected_currency }}';
    return new Intl.NumberFormat('en-GB', {
        style: 'currency',
        currency: currency
    }).format(amount);
}
</script>
{% endblock %}